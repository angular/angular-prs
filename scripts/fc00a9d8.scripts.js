"use strict";angular.module("angularPrsApp",[]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("angularPrsApp").controller("MainCtrl",["$scope","github","dateFilter",function(a,b,c){var d={},e=[],f=[],g={},h={pendingCount:0};console.log("loading data..."),b.prs().then(function(b){console.log("counting..."),b.forEach(function(a){var b,c;g[a.number]&&console.error("Found duplicate PR: ",a),g[a.number]=!0,b=a.created_at.split("T")[0],c=d[b]=d[b]||{},c.createdCount=(c.createdCount||0)+1,a.closed_at&&(b=a.closed_at.split("T")[0],c=d[b]=d[b]||{},c.closedCount=(c.closedCount||0)+1)}),console.log("creating day time series..."),Object.keys(d).sort().forEach(function(a){var b=d[a];b.date=a,b.createdCount=b.createdCount||0,b.closedCount=b.closedCount||0,b.pendingCount=h.pendingCount+b.createdCount-b.closedCount,e.push(b),h=b}),console.log("creating week time series...");var i,j,k={},l=0,m={pendingCount:0},n=60*(new Date).getTimezoneOffset()*1e3;Object.keys(d).sort().forEach(function(a){var b=d[a];new Date(a).getTime()<=l?(j.createdCount+=b.createdCount,j.closedCount+=b.closedCount):(i=i?c(l+1+n,"yyyy-MM-dd"):a,l=new Date(i).getTime()+6048e5,j={createdCount:b.createdCount,closedCount:b.closedCount},k[i]=j)}),Object.keys(k).sort().forEach(function(a){var b=k[a];b.date=a,b.createdCount=b.createdCount||0,b.closedCount=b.closedCount||0,b.pendingCount=m.pendingCount+b.createdCount-b.closedCount,f.push(b),m=b}),console.log("rendering..."),a.dayTimeSeries=e,a.dailyStart=0,a.dailyEnd=1e3,a.weekTimeSeries=f,a.weeklyStart=0,a.weeklyEnd=1e3})}]),angular.module("angularPrsApp").service("github",["$http","$q","$location",function(a,b){function c(c,d){for(var e=[],f=[],g=1;d>=g;g++)e.push(a.get("data/pulls-"+c+"/pulls-page-"+g+".json"));return b.all(e).then(function(a){return a.forEach(function(a){f=f.concat(a.data)}),f})}this.openPrs=function(){return c("open",4)},this.closedPrs=function(){return c("closed",51)},this.prs=function(){return b.all([this.openPrs(),this.closedPrs()]).then(function(a){var b=[];return a.forEach(function(a){b=b.concat(a)}),b})}}]),angular.module("angularPrsApp").directive("timeSeriesGraph",function(){return{restrict:"E",scope:{timeSeries:"=",start:"=",end:"="},link:function(a,b){function c(){var c=a.timeSeries;if(c){var d=(a.start||0)*a.timeSeries.length/1e3,e=(a.end||1e3)*a.timeSeries.length/1e3,f=angular.copy(c);f=f.splice(d,e);var g={top:20,right:80,bottom:30,left:50},h=960-g.left-g.right,i=500-g.top-g.bottom,j=d3.time.format("%Y-%m-%d").parse,k=d3.time.scale().range([0,h]),l=d3.scale.linear().range([i,0]),m=d3.scale.category10(),n=d3.svg.axis().scale(k).orient("bottom"),o=d3.svg.axis().scale(l).orient("left"),p=d3.svg.line().interpolate("basis").x(function(a){return k(a.date)}).y(function(a){return l(a.count)});b.empty();var q=d3.select(b[0]).append("svg").attr("width",h+g.left+g.right).attr("height",i+g.top+g.bottom).append("g").attr("transform","translate("+g.left+","+g.top+")");m.domain(d3.keys(f[0]).filter(function(a){return"date"!==a&&"$"!==a.charAt(0)})),f.forEach(function(a){a.date=j(a.date)});var r=m.domain().map(function(a){return{name:a,values:f.map(function(b){return{date:b.date,count:+b[a]}})}});k.domain(d3.extent(f,function(a){return a.date})),l.domain([d3.min(r,function(a){return d3.min(a.values,function(a){return a.count})}),d3.max(r,function(a){return d3.max(a.values,function(a){return a.count})})]),q.append("g").attr("class","x axis").attr("transform","translate(0,"+i+")").call(n),q.append("g").attr("class","y axis").call(o).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Count");var s=q.selectAll(".count").data(r).enter().append("g").attr("class","city");s.append("path").attr("class","line").attr("d",function(a){return p(a.values)}).style("stroke",function(a){return m(a.name)}),s.append("text").datum(function(a){return{name:a.name,value:a.values[a.values.length-1]}}).attr("transform",function(a){return"translate("+k(a.value.date)+","+l(a.value.count)+")"}).attr("x",3).attr("dy",".35em").text(function(a){return a.name.replace("Count","")})}}a.$watch("start",c),a.$watch("end",c),a.$watch("timeSeries",c)}}});