"use strict";angular.module("angularPrsApp",[]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("angularPrsApp").controller("MainCtrl",["$scope","github","dateFilter",function(a,b,c){var d={},e=[],f=[],g={},h={pendingCount:0};console.log("loading data..."),b.prs().then(function(b){console.log("counting..."),b.forEach(function(a){var b,c;g[a.number]&&console.error("Found duplicate PR: ",a),g[a.number]=!0,b=a.created_at.split("T")[0],c=d[b]=d[b]||{},c.createdCount=(c.createdCount||0)+1,a.closed_at&&(b=a.closed_at.split("T")[0],c=d[b]=d[b]||{},c.closedCount=(c.closedCount||0)+1)}),console.log("creating day time series..."),Object.keys(d).sort().forEach(function(a){var b=d[a];b.date=a,b.createdCount=b.createdCount||0,b.closedCount=b.closedCount||0,b.pendingCount=h.pendingCount+b.createdCount-b.closedCount,e.push(b),h=b}),console.log("creating week time series...");var i,j,k={},l=0,m={pendingCount:0},n=6e4*(new Date).getTimezoneOffset();Object.keys(d).sort().forEach(function(a){var b=d[a];new Date(a).getTime()<=l?(j.createdCount+=b.createdCount,j.closedCount+=b.closedCount):(i=i?c(l+1+n,"yyyy-MM-dd"):a,l=new Date(i).getTime()+6048e5,j={createdCount:b.createdCount,closedCount:b.closedCount},k[i]=j)}),Object.keys(k).sort().forEach(function(a){var b=k[a];b.date=a,b.createdCount=b.createdCount||0,b.closedCount=b.closedCount||0,b.pendingCount=m.pendingCount+b.createdCount-b.closedCount,f.push(b),m=b}),console.log("rendering..."),a.dayTimeSeries=e,a.weekTimeSeries=f})}]),angular.module("angularPrsApp").service("github",["$http","$q","$location",function(a,b){function c(c,d){for(var e=[],f=[],g=1;d>=g;g++)e.push(a.get("data/pulls-"+c+"/pulls-page-"+g+".json"));return b.all(e).then(function(a){return a.forEach(function(a){f=f.concat(a.data)}),f})}this.openPrs=function(){return c("open",2)},this.closedPrs=function(){return c("closed",50)},this.prs=function(){return b.all([this.openPrs(),this.closedPrs()]).then(function(a){var b=[];return a.forEach(function(a){b=b.concat(a)}),b})}}]),angular.module("angularPrsApp").directive("timeSeriesGraph",function(){return{restrict:"E",scope:{timeSeries:"="},link:function(a,b){a.$watch("timeSeries",function(a){if(a){var c=a,d={top:20,right:80,bottom:30,left:50},e=960-d.left-d.right,f=500-d.top-d.bottom,g=d3.time.format("%Y-%m-%d").parse,h=d3.time.scale().range([0,e]),i=d3.scale.linear().range([f,0]),j=d3.scale.category10(),k=d3.svg.axis().scale(h).orient("bottom"),l=d3.svg.axis().scale(i).orient("left"),m=d3.svg.line().interpolate("basis").x(function(a){return h(a.date)}).y(function(a){return i(a.count)}),n=d3.select(b[0]).append("svg").attr("width",e+d.left+d.right).attr("height",f+d.top+d.bottom).append("g").attr("transform","translate("+d.left+","+d.top+")");j.domain(d3.keys(c[0]).filter(function(a){return"date"!==a&&"$"!==a.charAt(0)})),c.forEach(function(a){a.date=g(a.date)});var o=j.domain().map(function(a){return{name:a,values:c.map(function(b){return{date:b.date,count:+b[a]}})}});h.domain(d3.extent(c,function(a){return a.date})),i.domain([d3.min(o,function(a){return d3.min(a.values,function(a){return a.count})}),d3.max(o,function(a){return d3.max(a.values,function(a){return a.count})})]),n.append("g").attr("class","x axis").attr("transform","translate(0,"+f+")").call(k),n.append("g").attr("class","y axis").call(l).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Count");var p=n.selectAll(".count").data(o).enter().append("g").attr("class","city");p.append("path").attr("class","line").attr("d",function(a){return m(a.values)}).style("stroke",function(a){return j(a.name)}),p.append("text").datum(function(a){return{name:a.name,value:a.values[a.values.length-1]}}).attr("transform",function(a){return"translate("+h(a.value.date)+","+i(a.value.count)+")"}).attr("x",3).attr("dy",".35em").text(function(a){return a.name.replace("Count","")})}})}}});